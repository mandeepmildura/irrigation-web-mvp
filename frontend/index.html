<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Irrigation Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 24px;
    }

    h1, h2 {
      margin-top: 30px;
    }

    .zone, .card {
      border: 1px solid #ddd;
      padding: 12px;
      margin-bottom: 16px;
      border-radius: 6px;
    }

    button {
      margin-right: 6px;
      padding: 6px 10px;
      cursor: pointer;
    }

    input, select {
      padding: 6px;
      margin-right: 6px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }

    th, td {
      border-bottom: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }

    th {
      background: #f4f4f4;
    }
  </style>
</head>
<body>

<h1>üå± Irrigation Dashboard</h1>

<div class="card">
  <strong>API Access</strong><br/><br/>
  <label>API Key: <input type="password" id="apiToken" placeholder="X-API-Key value" /></label>
  <button onclick="setToken()">Save</button>
</div>

<!-- ================= ZONES ================= -->
<h2>Zones</h2>
<div id="zones"></div>

<!-- ============== SCHEDULE EDITOR ============== -->
<h2>üìÖ Schedules</h2>

<div class="card">
  <strong>Create Schedule</strong><br/><br/>

  <select id="scheduleZone"></select>

  <input type="time" id="scheduleTime" />

  <input type="number" id="scheduleMinutes" value="10" min="1" />

  <input type="text" id="scheduleDays" placeholder="mon,wed,fri or *" value="*" />

  <input type="number" id="scheduleMoisture" placeholder=">= moisture skip" step="0.1" min="0" />

  <input type="number" id="scheduleLookback" value="120" min="15" max="1440" />

  <label><input type="checkbox" id="scheduleEnabled" checked /> Enabled</label>

  <button onclick="createSchedule()">Add</button>
</div>

<table>
  <thead>
    <tr>
      <th>Zone</th>
      <th>Start Time</th>
      <th>Minutes</th>
      <th>Enabled</th>
      <th>Days</th>
      <th>Moisture rule</th>
    </tr>
  </thead>
  <tbody id="scheduleTable"></tbody>
</table>

<!-- ================= CHARTS ================= -->
<h2>üìà Charts</h2>
<div class="card">
  <strong>Sensor Series</strong><br/><br/>
  <select id="chartZone"></select>
  <select id="chartMetric"></select>
  <select id="chartRange"></select>
  <button onclick="loadChartSeries()">Load</button>
</div>
<div class="card">
  <canvas id="chartCanvas" height="180"></canvas>
</div>

<!-- ================= RUN HISTORY ================= -->
<h2>Recent Runs</h2>
<table>
  <thead>
    <tr>
      <th>Time (Melbourne)</th>
      <th>Zone</th>
      <th>Minutes</th>
      <th>Source</th>
    </tr>
  </thead>
  <tbody id="runs"></tbody>
</table>

<script>
const API = "";
const TOKEN_KEY = "irrigation_api_token";
const METRICS = ["moisture", "temperature", "humidity", "pressure", "flow"];
const RANGES = [6, 12, 24, 72, 168];
let chartInstance = null;

function getHeaders() {
  const token = localStorage.getItem(TOKEN_KEY) || "";
  return token ? { "X-API-Key": token } : {};
}

function setToken() {
  const token = document.getElementById("apiToken").value.trim();
  if (token) {
    localStorage.setItem(TOKEN_KEY, token);
  } else {
    localStorage.removeItem(TOKEN_KEY);
  }
 loadZones().then(() => {
  loadSchedules();
  loadChartSeries();
});
loadRuns();

}

/* ================= TIME ================= */
function formatMelbourne(ts) {
  const iso = ts.endsWith("Z") ? ts : ts + "Z";
  return new Intl.DateTimeFormat("en-AU", {
    timeZone: "Australia/Melbourne",
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit",
    hour12: false
  }).format(new Date(iso));
}

/* ================= ZONES ================= */
let zonesCache = [];

async function loadZones() {
  const res = await fetch(`${API}/zones`, { headers: getHeaders() });
  zonesCache = await res.json();

  const zonesDiv = document.getElementById("zones");
  const select = document.getElementById("scheduleZone");
  const chartZone = document.getElementById("chartZone");

  zonesDiv.innerHTML = "";
  select.innerHTML = "";
  chartZone.innerHTML = "";

  zonesCache.forEach(z => {
    // Zone card
    const div = document.createElement("div");
    div.className = "zone";
    div.innerHTML = `
      <strong>${z.name}</strong><br/><br/>
      <button onclick="runZone('${z.name}',1)">Run 1 min</button>
      <button onclick="runZone('${z.name}',5)">Run 5 min</button>
      <button onclick="runZone('${z.name}',10)">Run 10 min</button>
    `;
    zonesDiv.appendChild(div);

    // Schedule dropdown
    const opt = document.createElement("option");
    opt.value = z.id;
    opt.textContent = z.name;
    select.appendChild(opt);

    const chartOpt = document.createElement("option");
    chartOpt.value = z.name;
    chartOpt.textContent = z.name;
    chartZone.appendChild(chartOpt);
  });
}

/* ================= MANUAL RUN ================= */
async function runZone(zone, minutes) {
  await fetch(`${API}/run/${encodeURIComponent(zone)}?minutes=${minutes}`, {
    method: "POST",
    headers: getHeaders()
  });
  setTimeout(loadRuns, 500);
}

/* ================= RUN HISTORY ================= */
async function loadRuns() {
  const res = await fetch(`${API}/runs?limit=20`, { headers: getHeaders() });
  const runs = await res.json();

  const tbody = document.getElementById("runs");
  tbody.innerHTML = "";

  runs.forEach(r => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${formatMelbourne(r.ts)}</td>
      <td>${r.zone_name}</td>
      <td>${r.duration_minutes}</td>
      <td>${r.source}</td>
    `;
    tbody.appendChild(tr);
  });
}

/* ================= CHARTS ================= */
function initChartSelectors() {
  const metricSelect = document.getElementById("chartMetric");
  const rangeSelect = document.getElementById("chartRange");

  metricSelect.innerHTML = "";
  METRICS.forEach(m => {
    const opt = document.createElement("option");
    opt.value = m;
    opt.textContent = m;
    metricSelect.appendChild(opt);
  });

  rangeSelect.innerHTML = "";
  RANGES.forEach(h => {
    const opt = document.createElement("option");
    opt.value = h;
    opt.textContent = `${h}h`;
    rangeSelect.appendChild(opt);
  });
  rangeSelect.value = 24;
}

async function loadChartSeries() {
  const zone = document.getElementById("chartZone").value;
  const metric = document.getElementById("chartMetric").value;
  const hours = Number(document.getElementById("chartRange").value || 24);

  if (!zone || !metric) {
    return;
  }

  const res = await fetch(`${API}/chart/series?zone_name=${encodeURIComponent(zone)}&metric=${encodeURIComponent(metric)}&hours=${hours}`, { headers: getHeaders() });
  const series = await res.json();

  const labels = series.map(p => formatMelbourne(p.ts));
  const values = series.map(p => p.value);

  const ctx = document.getElementById("chartCanvas").getContext("2d");
  if (chartInstance) {
    chartInstance.destroy();
  }

  chartInstance = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [
        {
          label: `${metric} (${zone})`,
          data: values,
          fill: false,
          borderColor: "#2c7a7b",
          tension: 0.2
        }
      ]
    },
    options: {
      plugins: { legend: { display: true } },
      scales: {
        x: { display: true, ticks: { maxTicksLimit: 8 } },
        y: { beginAtZero: false }
      }
    }
  });
}

/* ================= SCHEDULES ================= */
async function loadSchedules() {
  const res = await fetch(`${API}/schedules`, { headers: getHeaders() });
  const schedules = await res.json();

  const tbody = document.getElementById("scheduleTable");
  tbody.innerHTML = "";

  schedules.forEach(s => {
    const zone = zonesCache.find(z => z.id === s.zone_id);
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${zone ? zone.name : s.zone_id}</td>
      <td>${s.start_time}</td>
      <td>${s.duration_minutes}</td>
      <td>${s.enabled ? "‚úÖ" : "‚ùå"}</td>
      <td>${s.days_of_week || "*"}</td>
      <td>${s.skip_if_moisture_over ? `skip ‚â• ${s.skip_if_moisture_over} (last ${s.moisture_lookback_minutes}m)` : "-"}</td>
    `;
    tbody.appendChild(tr);
  });
}

async function createSchedule() {
  const zoneId = document.getElementById("scheduleZone").value;
  const time = document.getElementById("scheduleTime").value;
  const minutes = document.getElementById("scheduleMinutes").value;

  if (!time) {
    alert("Select start time");
    return;
  }

  await fetch(`${API}/schedules`, {
    method: "POST",
    headers: { "Content-Type": "application/json", ...getHeaders() },
    body: JSON.stringify({
      zone_id: Number(zoneId),
      start_time: time,
      duration_minutes: Number(minutes),
      enabled: document.getElementById("scheduleEnabled").checked,
      days_of_week: document.getElementById("scheduleDays").value,
      skip_if_moisture_over: document.getElementById("scheduleMoisture").value || null,
      moisture_lookback_minutes: Number(document.getElementById("scheduleLookback").value)
    })
  });

  loadSchedules();
}

/* ================= INIT ================= */
document.getElementById("apiToken").value = localStorage.getItem(TOKEN_KEY) || "";

initChartSelectors();

loadZones().then(() => {
  loadSchedules();
  loadChartSeries();
});

loadRuns();
setInterval(loadRuns, 10000);

</script>

</body>
</html>
